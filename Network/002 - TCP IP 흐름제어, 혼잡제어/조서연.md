# TCP/IP 흐름제어, 혼잡제어

인터넷: 전 세계에 걸쳐 데이터 통신 서비스를 받을 수 있는 컴퓨터 네트워크의 시스템

TCP/IP: 인터넷에서 컴퓨터들이 서로 정보를 주고 받는데 쓰이는 프로토콜의 집합

TCP/IP의 계층

- Application Layer
    
    특정 서비스를 제공하기 위해 애플리케이션 끼지 정보를 주고 받는다.
    
    FTP, HTTP, SSH
    
- **Transport Layer**
    
    End Point간 신뢰성있는 데이터 전송을 담당한다.
    
    TCP, UDP
    
- Internet Layer
    
    수신 측까지 데이터를 전달하기 위해 사용한다.
    
    IP, ARP, ICMP
    
- Network Access Layer
    
    네트워크에 직접 연결된 기기 간 전송을 한다.
    
    Ethernet, PPP
    

### Transport Layer

End Point간 신뢰성있는 데이터 전송을 담당한다.

신뢰성: 데이터를 순차적으로 안정적으로 전달한다.

전송: 포트 번호에 해당하는 프로세스에게 데이터를 전달한다.

### TCP, Transmission Control Protocol

- 신뢰적, 연결지향
- TCP는 unreliable network에서 신뢰성있는 데이터 통신을 가능하게 해주는 프로토콜이다.

네트워크 통신과정에 네트워크 혼잡이나 receiver의 오버로드 등의 이유로 다음과 같은 문제가 발생할 수 있다. 

- 손실: 패킷이 손실될 수 있다.
- 순서 바뀜: 패킷의 순서가 바뀔 수 있다.
- 혼잡: 네트워크가 혼잡할 수 있다.
- 오버로드: 리시버가 오버로드될 수 있다.

이러한 문제를 해결하고 통신의 신뢰성을 보장하기 위해 TCP/IP에서 사용하는 것이 흐름 제어와 혼잡 제어다. 그래서 TCP는

데이터의 순차적인 전송을 보장하고, 흐름 제어, 혼잡 제어, 오류 감지를 한다.

**Segment**

프로토콜에서 데이터는 세그먼트 단위로 처리된다. application 레이어에서 데이터를 자르고, 각 데이터 조각에 TCP 헤더를 붙이면 이것이 세그먼트

## 흐름 제어

receiver의 데이터 처리 속도가 sender 보다 빠르면 문제가 없지만 sender의 속도가 더 빠른 경우 문제가 발생한다. reveiver의 저장 용량을 초과한 이후에 도착하는 패킷은 손실될 수 있고, 패킷이 손실되면 추가적인 패킷 전송이 발생한다. 

흐름제어는 이러한 receiver와 sender의 데이터 처리 속도 차이에서 발생하는 문제를 해결한다.

### Stop and Wait

매번 전송한 패킷에 대한 응답(ACK)을 받으면 다음 패킷을 전송하는 방법이다.

### Sliding Window

receiver 측에서 설정한 윈도우 크기만큼 송신 측에서 응답없이 패킷을 전송할 수 있게 하여 데이터 흐름을 동적으로 조절한다.

최초 윈도우 크기는 3 way handshaking을 통해 설정되며, 이후 receiver 측 버퍼에 남아있는 공간에 따라 변한다. 윈도우 크기는 receiver에서 sender로 ACK을 보낼 때 TCP 헤더에 담아서 보낸다. 

1. receiver는 최초 윈도우 사이즈를 정한다.
2. sender는 receiver로부터 ACK이 올 때까지 데이터를 보낸다.
3. ACK이 오면, 슬라이딩 윈도우 사이즈를 충족할 수 있도록 윈도우를 이동한다.
4. 데이터를 모두 받을 때까지 위 과정을 반복한다. 

## 혼잡 제어

데이터 양이 라우터가 처리할 수 있는 양을 초과할 수 있다. 처리하지 못한 데이터는 손실 데이터가 되어 재전송이 발생하고 재전송이 많아지면 네트워크가 혼잡해진다. 그래서 sender의 전송 속도를 적절히 조절하여 혼잡 제어를 한다. 즉 네트워크 내 패킷 수를 조절하여 네트워크의 오버플로우를 방지한다. 

### AIMD (Additive Increase/Multicative Decrease)

처음에 패킷을 하나씩 보내고, 문제 없이 도착하면 윈도우 크기를 1씩 증가시킨다. 전송에 실패하면 윈도우 크기를 절반으로 줄인다. 

윈도우 크기를 서서히 늘리기 때문에 네트워크의 모든 대역을 활용하여 적절한 속도로 통신하기까지 시간이 오래걸린다.

### Slow Start

윈도우 크기를 1, 2, 4, 8 … 지수적으로 증가시키고 혼잡해져 전송에 실패하면 윈도우 크기를 1 줄이는 방식이다. AIMD와 비교했을 때 제대로된 속도에 도달하는 속도가 빠르다.

### Fast Retransmit

receiver에게 세그먼트로 분할된 내용들이 순서대로 도착하지 않는 경우가 있다. 이 경우 receiver는 순서대로 잘 도착한 패킷 중 마지막 패킷의 다음 순번을 ACK에 담아서 보낸다. sender가 이런 중복 ACK을 3개 받으면 재전송이 이루어진다. sender가 자신이 설정한 타임 아웃 시간이 아직 안되었어도 해당 패킷을 재전송하기에 빠른 재전송이 이뤄진다.

### Fast Recovery

혼잡한 상태가 되면 윈도우 크기를 절반으로 줄이고 선형 증가시킨다. 즉 혼잡 상황을 한 번 겪고나면 AIMD 방식으로 동작한다. 

### 혼잡 제어 정책

TCP에는 다양한 혼잡 제어 정책이 존재한다. 혼잡 제어 정책은 공통적으로 혼잡이 발생하면 윈도우 크기를 줄이거나 그대로 유지하고, 혼잡을 회피한다.

대표적인 혼잡 제어 정책인 Tahoe와 Reno는 Slow Start 방식으로 시작했다가 네트워크가 혼잡하다고 느껴지면 AIMD 방식으로 전환한다.
