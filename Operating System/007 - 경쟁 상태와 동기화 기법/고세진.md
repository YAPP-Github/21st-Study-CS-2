# 세마포와 뮤텍스

## Background

### 공유자원

입출력 장치, 보조기억장치, 공유 가능한 전역변수 등 여러 **프로세스나 스레드가** 동시에 접근할 수 있는 자원

### 임계 영역

동시에 실행하면 문제가 되는, 공유자원에 접근할 수 있는 코드

### 경쟁 조건

임계 영역을 여러 프로세스나 스레드가 접근해서 문제가 생기는 경우

### 동기화의 목적

작업들 사이의 수행 시기를 맞추는 것

1. 실행 순서 제어를 위한 동기화 
    - EX ) 쓰기 전에 읽기 방지
2. 상호 배제를 위한 동기화
    - EX ) 한 변수에 동시 덧셈 방지 (중복 쓰기 방지)
    - 문제 해결을 위한 원칙
        1. **상호 배제**(mutual exclusion) : 한 프로세스가 진입했다면 다른 프로세스는 진입 불가
        2. **진행**(progress) : 임계 구역에 어떤 프로세스도 진입하지 않았다면, 임계 구역에 다른 프로세스가 진입할 수 있음
        3. **유한 대기** (bounded wating) : 한 프로세스가 임계 구역에 진입하고 나면, 언젠가는 임계 구역에 들어올 수 있어야 함. 
            
            

## 뮤택스 락

전역변수를 이용해 자물쇠를 구현하는 방법

**구현에 필요한 내용**

1. 프로세스들이 공유하는 전역변수 **lock -** 자물쇠 잠김 여부를 표현한다고 보자.
2. 임계 구역을 잠그는 함수 **acquire**
3. 임계 구역의 잠금을 해제하는 함수 **release**

```kotlin
acquire(); // 락을 획득할 수 없으면 무작정 기다린다
임계구역의 공유자원 접근 // 락을 획득하면, 임계구역을 잠그고 작업
release(); // 임계구역을 빠져나오면서 잠금 해제 
```

```kotlin
acquire(){
	while(lock == true)  // **Busy Waiting**
		; 
	// lock이 false인 상태
	lock = true
}
// 임계영역 실행 

release() {
	lock = false
}
```

### 뮤택스의 특징

busy waiting

## 세마포

뮤택스 락보다 일반화된 방식의 동기화 도구.

공유 자원이 여러개 있는 경우에 작동할 수 있다.

**구현에 필요한 내용**

1. 임계 구역에 진입할 수 있는 프로세스 개수 (전역변수) S
    
    == 사용할 수 있는 자원 개수
    
2. 임계 구역에 들어가도 좋은지 판단하고, 아닌 경우 프로세스를 대기 큐에 넣는 wait()함수
3. 임계 구역 진입을 기다리는 프로세스에게 진입 신호를 주는 signal 함수

상호 배제를 위한 동기화 구현

```kotlin
wait() // 임계 구역 진입시 호출
임계 구역의 공유자원 접근
signal() // 임계 구역 이탈시 호출
```

설명을 위한 구현 1

```kotlin
 S = 1
wait() {
	while( S <= 0) // 실제로는 busy wating을 하지 않음
	;
	S-- // 자원이 있으면 1 감소시키고 진입
}
// 임계영역
signal() {
	S++ // 작업 마친 뒤 자원 반환
}
```

진짜 구현

```kotlin

wait(){
	S.value --; 일단 S를 줄인다
	if (S.value < 0){ 자원이 없는 상태에서 wait 호출한 경우
		S.list.add(process)
		sleep()
	}
}
// 임계 영역

signal(){
	S ++ 
	if ( S<= 0) { S가 음수였다면 (대기중인 프로세스가 있다면)
	
		p = S.list.remove()
		wakeup(p)   // p를 깨운다. 
	}
}
```

실행 순서를 위한 동기화 구현  : Thead1이 먼저 접근하기 원할 때

```kotlin
[Thread1]
임계 구역
signal()
```

```kotlin
[Thread2]
wait()
임계구역
```

Thread1이 먼저 실행시 원하는 대로 임계 구역 실행 순서 동기화 보장

Thread2가 먼저 실행되더라도, 역시 동기화 보장 (Thread2가 대기상태로 간다)

### 뮤택스 vs 세마포

[뮤택스]

상호배제 동기화

1개의 자원에 대한 수단

busy wating을 통해 진입

[세마포]

상호배제, 실행 순서 제어를 위한 동기화

자원이 여러개일 때에도 사용 가능

sleep() and wakeup()을 이용해 진입

[https://velog.io/@lcy960729/Semaphores-세마포어](https://velog.io/@lcy960729/Semaphores-%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4)

### 더 공부해볼 내용

모니터

volatile과 synchronized의 공통점, 차이점 

스핀