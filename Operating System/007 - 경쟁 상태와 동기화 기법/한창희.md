- 공유 자원??
    - 시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 모니터, 프린터, 메모리, 파일 등의 자원 및 변수를 의미

- **경쟁 상태**?? = race condition
    - 여러 프로세스/스레드가 동시에 같은 데이터에 접근할 때 타이밍/접근 순서에 따라 결과가 달라질 수 있는 상황
    - 교착 상태의 종류 중 하나
    
- 동기화??
    - 여러 프로세스/스레드를 동시에 실행해도 공유 데이터의 일관성을 유지하는 것
    
- 동기화가 왜 필요???
    - 두 개의 스레드가 공통 변수 num의 값을 1씩 증가 시키는 메서드를 수행한다 하는 경우 항상 2씩 증가함을 보장할 수 없다 / num++;
    - A 스레드가 num에 값을 증가시키는 과정을 cpu 레벨에서 보면 여러 명령문의 조합이 존재
        - LOAD num to R1
        - R1 = R1 + 1  (여기서 컨텍스트 스위칭 발생 가능)
        - STORE R1 to num
    - 위 과정을 거치게 된다
    - 스레드 A가 작업하던 도중 컨텍스트 스위칭이 일어나 메모리에 증가한 값이 저장되기 전에 스레드 B가 시작할 수 있다
        - 스레드 B 입장에서는 스레드 A 의 작업이 반영되지 않은 메모리 상태를 기준으로 작업을 시작하므로 위와 같은 현상 발생
        
- 어떻게 동기화를 시킬 것인가??
    - 컨텍스트 스위칭을 막으면 되지 않을까??
        - 멀티 코어의 경우에는 불가능
        
    - num을 증가 시키는 메서드 자체를 한 스레드만 접근이 가능하게 해보자
        - 한 스레드의 메서드 호출이 끝나기 전까지는 다른 스레드가 기다리는 것
            - 멀티코어의 상황에서도 적용 가능
    
- 임계 영역 (critical section)
    - 위와 같이 공유 데이터의 일관성을 보장하기 위해 하나의 프로세스/스레드만 진입해서 실행 가능한 영역을 임계 영역이라 한다 - 동기화 대상
    - = 경쟁상태에서 공유자원을 사용하게 되는 영역
    - = 코드의 일부라고 생각해도 된다 → 쓰레드 혹은 프로세스가 공유하고 있는 변수가 있는 코드 조각
    
- 임계 영역 해결 조건
    1. **상호 배제(mutual exclusion)**
        1. 한 프로세스가 임계구역에 들어가면 다른 프로세스는 임계구역에 들어갈 수 없다.
    2. **한정 대기(bounded waiting)** 
        1. 상호 배제 때문에 기다리게 되는 프로세스가 무한 대기하지 않아야 한다. 즉, 특정 프로세스가 임계구역에 진입하지 못하면 안된다.
    3. **진행의 융통성(progress flexibility, progress)**
        1. 임계구역에 프로세스가 없다면 어떠한 프로세스라도 들어가서 자원을 활용할 수 있다. 즉, 두 프로세스가 자원을 번갈아 쓴다고 가정할 때 한 쪽에서 자원을 안쓰고 있다고해서 다른 한 쪽 프로세스가 자원을 쓰고싶어도 자신의 turn이 아니라고 기다리는 것은 효율적이지 못하다는 것이다.
            
            = 한 프로세스가 다른 프로세스를 방해하면 안된다
            
    
    - 위 방법들의 기본 메커니즘은 lock
        - 임계 구역을 화장실이라 하면 사람1 이 들어가서 문을 잠근다
        - 다음 사람은 사람1이 문을 다시 열고 나올때 까지 기다려야 한다

[https://structuring.tistory.com/m/151](https://structuring.tistory.com/m/151)

- 경쟁 상태가 일어나는 경우
    - 프로세스의 시스템 콜에 의해 커널 모드를 수행 중인데 CPU가 다른 프로세스에 넘어가는 경우
        - 프로세스 A가 시스템 콜을 호출하여 데이터를 변경하려고 하고 있었다. 하지만 변경이 채 완료되기 전에 프로세스 B 또한 시스템 콜을 하여 운영체제가 동일한 데이터를 변경한 경우 다시 프로세스 A에게 운영체제가 넘어갔을 때, 프로세스 B가 변경한 데이터를 전달하지 못할 수 있다. 이런 경우 CPU가 1개여도 이렇게 race condition가 발생되어 데이터가 잘못될 수 있다.
        - 해결법
            - 이런 경우의 해결책은 커널 모드 중에서는 CPU를 선점(preempt) 하지 않는 것이다. 즉, 커널 모드에서는 CPU를 빼앗지 않고 사용자 모드가 되었을 때 빼앗는 것이다.
    - 커널 모드 중 인터럽트 발생하는 경우
        - 커널 모드가 수행 중인 상태에서 인터럽트가 발생하여 인터럽트 처리 루틴이 실행되는 상황이다.
        - 해결법
            - 커널의 고유 변수의 값을 건드리는 동안에는 인터럽트가 발생해도 disable 하여 인터럽트가 연산이 끝나고 수행될 수 있게 한다.
    - 멀티 프로세서에서 공유 메모리의 커널 데이터
        - CPU가 2개 이상일 때는, 커널 모드 중 인터럽트를 막는 차원이 아니다. 인터럽트를 CPU 한쪽에서 막았다고 해서 다른 쪽 CPU가 데이터를 사용하는 것을 막을 수 없기 때문이다.
        - CPU가 메모리에서 데이터를 가져오기 전에 lock을 걸어 다른 CPU가 같은 데이터에 접근하는 것을 막아 준다. 연산이 끝난 후 데이터를 다시 메모리에 저장할 때 lock을 풀어 줌으로써 다른 CPU가 접근할 수 있게 해 준다.
        - 해결법
            - 한 번에 하나의 CPU만 운영체제를 사용하도록, 즉 1개씩만 커널에 들어갈 수 있게 하는 방법이 있다. 커널 전체에 lock을 걸기 때문에 비효율적이다.
            - 커널 내부에 있는 각 공유 데이터에 접근할 때마다 해당 데이터에 lock을 거는 방법이 있다. 한쪽 CPU가 공유 데이터를 사용 중일 때 lock을 건다.

---
---

- 세마포어 & 뮤텍스 → **둘 모두 공유된 자원의 데이터를 여러 스레드/프로세스가 접근하는 것을 막는 역할!**

### < 뮤텍스 >

- 스레드가 공유자원을 lock()을 통해 잠금 설정하고 사용한 후 unlock()을 통해 잠금해제하는 객체
- 뮤텍스는 잠금 / 잠금해제 의 상태만을 가진다!

- **lock** : 현재 임계 구역에 들어갈 권한을 얻어옴 ( 만약 다른 프로세스/스레드가 임계 구역 수행 중이면 종료할 때까지 대기 )
- **unlock** : 현재 임계 구역을 모두 사용했음을 알림. ( 대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있음 )

→ 뮤텍스는 상태가 0, 1로 **이진 세마포어** 로 부르기도 한다

---

### < 세마포어 >

- 일반화된 뮤텍스
- 두 가지 함수 wait(P), signal(V) 로 공유 자원에 대한 접근을 처리

- wait() : 자신의 차례가 올 때까지 기다리는 함수
- signal() : 다음 프로세스로 순서를 넘겨주는 함수

- 프로세스가 공유 자원에 접근하면 세마포어에서 wait 작업을 수행하고 프로세스가 공유 자원을 해제하면 세마포어에서 signal 작업을 수행한다

---

- 세마포어
    - 조건 변수가 없다
    - 프로세스가 세마포어 값을 수정할 때 다른 프로세스는 동시에 세마포어 값을 수정할 수 없다
    - 여러 개의 임계영역 접근을 처리할 수 있다

- 뮤텍스
    - 한 개의 프로세스 또는 스레드만의 임계영역 접근을 처리한다
    

### 바이너리 세마포어

- 0과 1의 두 가지 값만 가질 수 있는 세마포어
- 구현의 유사성으로 뮤텍스는 바이너리 세마포어라고 할 수 있다
- 하지만 엄밀히 말하면 뮤텍스는 잠금(lock)을 기반으로 상호배제가 일어나는 잠금 메커니즘이 들어간 객체이고
- 세마포어는 신호를 기반으로 상호배제가 일어나는 신호메커니즘이 들어간 객체이다
    - 상호배제??
    - 상호 배제란, 임계 구역을 어느 시점에서 단지 한 개의 프로세스만이 사용할 수 있도록 하며, 다른 프로세스가 현재 사용 중인 임계 구역에 대하여 접근하려고 할 때 이를 금지하는 행위
- 신호 메커니즘?
    - 휴대폰에서 노래를 듣다가 친구로부터 전화가 오면 노래가 중지되고 통화 처리작업에 관한 인터페이스가 등장하는 것을 상상하면 된다
    

### 카운팅 세마포어

- 여러개의 값을 가질 수 있는 세마포어
- 여러 자원에 대한 접근을 제어하는 데 사용
